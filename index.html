<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dzuhur 12 - Smart Gate V5</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d1117">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0d1117; color: #c9d1d9; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(22, 27, 34, 0.8); backdrop-filter: blur(10px); border: 1px solid #30363d; }
        .active-tab { background: #0891b2; color: white; box-shadow: 0 0 20px rgba(8, 145, 178, 0.5); }
        .active-mode-islam { background: #15803d; color: white; border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
        .active-mode-kristen { background: #1d4ed8; color: white; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        #reader { border: none !important; border-radius: 1.5rem; overflow: hidden; background: #000; }
        .log-item { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="pb-10">

    <div id="loading-overlay" class="fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center gap-4 transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-cyan-400 font-bold text-[10px] tracking-[0.3em] animate-pulse uppercase">SINKRONISASI DATABASE...</p>
    </div>

    <header class="py-8 text-center relative">
        <h1 class="text-4xl font-extrabold bg-gradient-to-b from-white to-gray-500 bg-clip-text text-transparent italic uppercase tracking-tighter">Dzuhur 12</h1>
        <p class="text-[9px] text-cyan-500 mt-2 uppercase tracking-[0.3em] font-black italic">Rohis Sma 12 Jakarta</p>
        <button id="btn-logout" onclick="prosesLogout()" class="hidden absolute top-4 right-4 bg-red-900/30 text-red-500 border border-red-500/30 px-3 py-1.5 rounded-xl text-[8px] font-black uppercase tracking-widest">Logout</button>
    </header>

    <div class="flex justify-center mb-8 px-4 relative z-[50]">
        <div class="glass p-1.5 rounded-2xl flex gap-2 w-full max-w-[320px]">
            <button onclick="switchTab('admin')" id="btn-admin" class="flex-1 py-3.5 rounded-xl font-bold active-tab text-xs transition-all duration-300">üé´ KARTU</button>
            <button onclick="switchTab('scan')" id="btn-scan" class="flex-1 py-3.5 rounded-xl font-bold text-gray-400 text-xs transition-all duration-300">üì∑ SCANNER</button>
        </div>
    </div>

    <div id="modal-login" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[999] flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] border border-cyan-500/30 text-center">
            <h2 class="text-xl font-bold text-white mb-6 italic uppercase tracking-widest">PILIH AKSES LOGIN</h2>
            <div class="space-y-3">
                <select id="login-role" class="w-full bg-gray-900 border border-gray-700 p-4 rounded-2xl outline-none text-white text-sm mb-2">
                    <option value="sekretaris">SEKRETARIS KELAS</option>
                    <option value="piket">GURU PIKET</option>
                    <option value="guru">GURU / WALAS</option>
                    <option value="admin">ADMIN SISTEM</option>
                </select>
                <input type="text" id="login-user" placeholder="Username / Kelas (Contoh: X-1)" class="w-full bg-gray-900 border border-gray-700 p-4 rounded-2xl outline-none text-white focus:border-cyan-500 text-center text-sm">
                <input type="password" id="login-pass" placeholder="Password" class="w-full bg-gray-900 border border-gray-700 p-4 rounded-2xl outline-none text-white focus:border-cyan-500 text-center text-sm">
                <button onclick="prosesLoginMulti()" class="w-full py-4 bg-cyan-600 text-white font-bold rounded-2xl shadow-lg uppercase text-xs mt-4">MASUK</button>
            </div>
        </div>
    </div>

    <div id="modal-izin" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[999] hidden items-center justify-center p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] border border-orange-500/30 text-center">
            <h2 class="text-xl font-bold text-white mb-4 italic">INPUT IZIN SISWA</h2>
            <p id="nama-siswa-izin" class="text-cyan-400 font-bold mb-6 uppercase"></p>
            <div class="grid gap-3">
                <button onclick="updateStatusIzin('IZIN SAKIT')" class="py-4 bg-red-900/40 text-red-400 border border-red-500/20 rounded-2xl font-bold text-xs uppercase">ü§í Sakit / Pulang</button>
                <button onclick="updateStatusIzin('PULANG CEPAT')" class="py-4 bg-orange-900/40 text-orange-400 border border-orange-500/20 rounded-2xl font-bold text-xs uppercase">üè† Pulang Cepat</button>
                <button onclick="updateStatusIzin('DISPENSASI')" class="py-4 bg-blue-900/40 text-blue-400 border border-blue-500/20 rounded-2xl font-bold text-xs uppercase">üèÜ Dispensasi</button>
                <button onclick="tutupModalIzin()" class="mt-4 text-gray-500 text-[10px] uppercase font-bold italic">Batal</button>
            </div>
        </div>
    </div>

    <main class="max-w-2xl mx-auto px-4">
        <section id="tab-admin" class="space-y-6">
            <div class="glass p-8 rounded-[2.5rem]">
                <h2 class="text-sm font-black mb-6 text-white uppercase tracking-widest italic">Pendaftaran Murid</h2>
                <div class="grid gap-4">
                    <input type="text" id="input-nama" placeholder="Nama Lengkap" class="w-full bg-gray-900 border border-gray-800 p-4 rounded-2xl outline-none text-white focus:border-cyan-500">
                    <div class="flex gap-4">
                        <select id="select-kelas-admin" class="w-1/2 bg-gray-900 border border-gray-800 p-4 rounded-2xl outline-none text-white text-sm"></select>
                        <input type="number" id="input-nis" placeholder="No. Absen" class="w-1/2 bg-gray-900 border border-gray-800 p-4 rounded-2xl outline-none text-white">
                    </div>
                    <div class="flex gap-4">
                        <select id="select-jk" class="w-1/2 bg-gray-900 border border-gray-800 p-4 rounded-2xl outline-none text-white text-sm">
                            <option value="L">LAKI-LAKI</option>
                            <option value="P">PEREMPUAN</option>
                        </select>
                        <select id="select-agama" class="w-1/2 bg-gray-900 border border-gray-800 p-4 rounded-2xl outline-none text-white text-sm">
                            <option value="Islam">ISLAM</option>
                            <option value="Kristen">KRISTEN</option>
                        </select>
                    </div>
                    <button onclick="buatQR()" class="bg-blue-600 py-4 rounded-2xl font-black text-xs uppercase tracking-widest mt-2 active:scale-95 transition-all">Generate & Simpan</button>
                </div>
            </div>
            <div id="qr-result-area" class="flex flex-col items-center"></div>

            <div id="bulk-area-guru" class="hidden glass p-8 rounded-[2.5rem] border border-yellow-500/20">
                <h2 class="text-sm font-black mb-2 text-yellow-500 uppercase italic">Bulk Daftar Murid</h2>
                <p class="text-[8px] text-gray-500 mb-4 uppercase font-bold tracking-widest italic">Format: Nama [Spasi] Absen [Spasi] JK (L/P) [Spasi] Agama</p>
                <textarea id="bulk-input" rows="4" placeholder="ASEP 1 L Islam&#10;SITI 2 P Islam" class="w-full bg-black/40 border border-gray-800 p-5 rounded-2xl text-xs text-white mb-4 outline-none"></textarea>
                <button onclick="prosesBulkQR()" id="btn-bulk" class="w-full py-4 bg-yellow-600 text-white font-bold rounded-2xl text-[10px] uppercase tracking-widest">üöÄ Download ZIP & Simpan</button>
            </div>
        </section>

        <section id="tab-scan" class="hidden space-y-6">
            <div class="glass p-2 rounded-[2rem] flex gap-2">
                <button onclick="setMode('Islam')" id="mode-islam" class="flex-1 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest border border-gray-800 text-gray-500 transition-all active-mode-islam">‚ò™Ô∏è Mode Islam</button>
                <button onclick="setMode('Kristen')" id="mode-kristen" class="flex-1 py-4 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest border border-gray-800 text-gray-500 transition-all">‚úùÔ∏è Mode Kristen</button>
            </div>

            <div class="flex gap-3">
                <button id="btn-start-cam" onclick="startScanner()" class="flex-1 py-5 bg-cyan-600 text-white font-black rounded-[2rem] text-[10px] uppercase tracking-widest">üì∑ Aktifkan Kamera</button>
                <button id="btn-stop-cam" onclick="stopScanner()" class="hidden flex-1 py-5 bg-red-600 text-white font-black rounded-[2rem] text-[10px] uppercase tracking-widest">üõë Matikan</button>
            </div>

            <div class="glass p-5 rounded-[3rem] border-2 border-cyan-500/10 relative min-h-[300px] flex items-center justify-center overflow-hidden">
                <div id="reader" class="w-full rounded-[2rem]"></div>
                <div id="scan-feedback" class="absolute inset-0 flex items-center justify-center rounded-[3rem] hidden z-10">
                    <div id="feedback-content" class="text-center text-white p-10 rounded-[3rem] shadow-2xl">
                        <div id="check-icons" class="text-6xl mb-3"></div>
                        <p id="scanned-name" class="text-2xl font-black uppercase tracking-tighter mb-1"></p>
                        <p id="scanned-info" class="text-[10px] opacity-80 font-bold uppercase"></p>
                    </div>
                </div>
            </div>

            <div class="glass p-6 rounded-[2.5rem]">
                <button onclick="downloadZipLaporan()" id="btn-zip-laporan" class="w-full py-5 bg-green-700 text-white font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-xl">üì¶ Download Rekap Harian (ZIP)</button>
                <div id="log-list" class="mt-8 space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
            </div>
        </section>
    </main>

    <div id="hidden-qr-engine" style="position: absolute; left: -9999px; top: 0;"></div>

    <script>
        // --- KONFIGURASI ---
        const PW_LIST = {
            admin: "admin123",
            piket: "piket12",
            sekretaris: { "X-1": "bintangX1", "X-2": "bintangX2", "X-3": "bintangX3" },
            guru: { "pak-yahya": "yahya123" }
        }; 
        const GITHUB_TOKEN = ""; // WAJIB ISI TOKEN
        const GIST_ID_UTAMA = "8f37fc18c4fb9bd3593486f97919ca9f"; 
        const DAFTAR_KELAS = ["X-1", "X-2", "X-3", "X-4", "X-5", "X-6", "XI-1", "XI-2", "XI-3", "XI-4", "XI-5", "XI-6", "XII-1", "XII-2", "XII-3", "XII-4", "XII-5", "XII-6"];
        
        // --- STATE ---
        let currentRole = null;
        let currentIdent = null;
        let isGuruLoggedIn = false;
        let localDB = {}; 
        let currentMode = 'Islam';
        let html5QrScanner;
        let tempIzinData = null;

        // --- INIT & PERSISTENCE ---
        async function init() {
            const savedRole = localStorage.getItem('userRole');
            const savedIdent = localStorage.getItem('userIdent');
            if (savedRole) {
                currentRole = savedRole; currentIdent = savedIdent; isGuruLoggedIn = true;
                updateUIAfterLogin(); aturFiturBerdasarkanRole();
            }
            const adminSelect = document.getElementById('select-kelas-admin');
            DAFTAR_KELAS.forEach(cls => { adminSelect.innerHTML += `<option value="${cls}">${cls}</option>`; });
            await loadAllData();
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // --- LOGIN LOGIC ---
        function prosesLoginMulti() {
            const role = document.getElementById('login-role').value;
            const user = document.getElementById('login-user').value.toUpperCase();
            const pass = document.getElementById('login-pass').value;
            let sukses = false;

            if (role === 'admin' && pass === PW_LIST.admin) { sukses = true; currentRole = 'ADMIN'; }
            else if (role === 'piket' && pass === PW_LIST.piket) { sukses = true; currentRole = 'PIKET'; }
            else if (role === 'sekretaris' && PW_LIST.sekretaris[user] === pass) { sukses = true; currentRole = 'SEKRETARIS'; currentIdent = user; }
            else if (role === 'guru' && PW_LIST.guru[user.toLowerCase()] === pass) { sukses = true; currentRole = 'GURU'; currentIdent = user; }

            if (sukses) {
                localStorage.setItem('userRole', currentRole);
                localStorage.setItem('userIdent', currentIdent || "");
                isGuruLoggedIn = true; tutupLogin(); updateUIAfterLogin(); aturFiturBerdasarkanRole();
                alert(`Login Berhasil: ${currentRole}`);
            } else alert("Akses Ditolak!");
        }

        function aturFiturBerdasarkanRole() {
            const bulk = document.getElementById('bulk-area-guru');
            bulk.classList.add('hidden');
            if (currentRole === 'ADMIN') switchTab('admin');
            else if (currentRole === 'GURU') { bulk.classList.remove('hidden'); switchTab('scan'); }
            else switchTab('scan');
        }

        function prosesLogout() { 
            if(confirm("Logout?")) { localStorage.clear(); window.location.reload(); }
        }

        // --- DATABASE ---
        async function loadAllData() {
            try {
                const res = await fetch(`https://api.github.com/gists/${GIST_ID_UTAMA}?t=${new Date().getTime()}`);
                const data = await res.json();
                DAFTAR_KELAS.forEach(cls => {
                    const fileName = `${cls}.json`;
                    localDB[cls] = data.files[fileName] ? JSON.parse(data.files[fileName].content) : [];
                });
                renderLog();
            } catch (e) { console.error("Database error"); }
        }

        async function syncToGithub(kelas) {
            if(!GITHUB_TOKEN) return;
            const fileName = `${kelas}.json`;
            await fetch(`https://api.github.com/gists/${GIST_ID_UTAMA}`, {
                method: "PATCH",
                headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ files: { [fileName]: { content: JSON.stringify(localDB[kelas], null, 2) } } })
            });
        }

        // --- ABSENSI & SCAN ---
        async function prosesAbsen(text) {
            const [nama, kelas, absen, jk, agama] = text.split('|');
            const now = new Date(); const today = now.toLocaleDateString('id-ID');
            if (agama !== currentMode) return showFeedback("‚ùå", nama, "SALAH PINTU!", "bg-red-700");
            if (localDB[kelas].some(d => d.Absen === absen && d.Tanggal === today)) return showFeedback("‚ö†Ô∏è", nama, "SUDAH SCAN!", "bg-yellow-600");

            let idx = localDB[kelas].findIndex(d => d.Absen === absen);
            if (idx !== -1) {
                localDB[kelas][idx].Jam = now.toLocaleTimeString('id-ID');
                localDB[kelas][idx].Tanggal = today;
                localDB[kelas][idx].Status = currentMode === 'Islam' ? 'DZUHUR' : 'IBADAH';
                localDB[kelas][idx].KehadiranKe = (parseInt(localDB[kelas][idx].KehadiranKe) || 0) + 1;
                showFeedback("‚úÖ", nama, "BERHASIL", "bg-green-600"); renderLog(); await syncToGithub(kelas);
            }
        }

        // --- FITUR GURU PIKET (IZIN) ---
        function renderLog() {
            const list = document.getElementById('log-list');
            const today = new Date().toLocaleDateString('id-ID');
            let allLogs = [];
            DAFTAR_KELAS.forEach(cls => { localDB[cls].filter(d => d.Tanggal === today).forEach(d => allLogs.push(d)); });
            allLogs.sort((a,b) => b.Jam.localeCompare(a.Jam));
            
            list.innerHTML = allLogs.length === 0 ? `<p class="text-center py-10 opacity-50 text-xs">Kosong</p>` :
                allLogs.map(d => `
                    <div class="log-item glass p-4 rounded-2xl flex justify-between items-center border-l-4 border-cyan-500 mb-2">
                        <div><b class="text-white text-xs uppercase">${d.Nama}</b><div class="text-[8px] text-gray-500">${d.Kelas} ‚Ä¢ ${d.Status} ‚Ä¢ ${d.Jam}</div></div>
                        <div class="flex gap-2">
                            ${currentRole === 'PIKET' || currentRole === 'ADMIN' ? `<button onclick="bukaModalIzin('${d.Nama}', '${d.Kelas}', '${d.Absen}')" class="bg-orange-600/20 text-orange-400 border border-orange-500/30 px-2 py-1 rounded-lg text-[8px] font-black">IZIN</button>` : ''}
                            <div class="bg-gray-900 px-3 py-1 rounded-lg text-cyan-400 font-black text-[10px]">#${d.KehadiranKe}</div>
                        </div>
                    </div>`).join('');
        }

        function bukaModalIzin(nama, kelas, absen) {
            tempIzinData = { nama, kelas, absen };
            document.getElementById('nama-siswa-izin').innerText = nama;
            document.getElementById('modal-izin').classList.remove('hidden');
            document.getElementById('modal-izin').classList.add('flex');
        }

        async function updateStatusIzin(tipe) {
            const { nama, kelas, absen } = tempIzinData;
            let idx = localDB[kelas].findIndex(d => d.Absen === absen);
            if (idx !== -1) {
                localDB[kelas][idx].Status = tipe;
                alert(`${nama}: ${tipe} Berhasil`);
                tutupModalIzin(); renderLog(); await syncToGithub(kelas);
            }
        }

        function tutupModalIzin() { document.getElementById('modal-izin').classList.add('hidden'); document.getElementById('modal-izin').classList.remove('flex'); }

        // --- DOWNLOAD & TOOLS ---
        async function downloadZipLaporan() {
            const zip = new JSZip(); const today = new Date().toLocaleDateString('id-ID');
            for (const cls of DAFTAR_KELAS) {
                if (localDB[cls].length > 0) {
                    const ws = XLSX.utils.json_to_sheet(localDB[cls]);
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "REKAP");
                    zip.file(`REKAP_${cls}.xlsx`, XLSX.write(wb, {bookType:'xlsx', type:'array'}));
                }
            }
            const content = await zip.generateAsync({type:"blob"});
            const l = document.createElement('a'); l.href = URL.createObjectURL(content); l.download = `ABSEN_SMA12.zip`; l.click();
        }

        // --- UI HELPERS ---
        function switchTab(t) { 
            if (!isGuruLoggedIn) { document.getElementById('modal-login').classList.remove('hidden'); return; } 
            document.getElementById('tab-admin').classList.toggle('hidden', t !== 'admin'); 
            document.getElementById('tab-scan').classList.toggle('hidden', t !== 'scan'); 
            document.getElementById('btn-admin').classList.toggle('active-tab', t === 'admin'); 
            document.getElementById('btn-scan').classList.toggle('active-tab', t === 'scan'); 
            if(t !== 'scan') stopScanner(); 
        }
        function tutupLogin() { document.getElementById('modal-login').classList.add('hidden'); }
        function updateUIAfterLogin() { document.getElementById('btn-logout').classList.remove('hidden'); }
        function startScanner() {
            document.getElementById('btn-start-cam').classList.add('hidden');
            document.getElementById('btn-stop-cam').classList.remove('hidden');
            if (!html5QrScanner) html5QrScanner = new Html5Qrcode("reader");
            html5QrScanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => prosesAbsen(text));
        }
        async function stopScanner() { if (html5QrScanner && html5QrScanner.isScanning) await html5QrScanner.stop(); document.getElementById('btn-start-cam').classList.remove('hidden'); document.getElementById('btn-stop-cam').classList.add('hidden'); }
        function showFeedback(i, n, f, b) {
            const fb = document.getElementById('scan-feedback');
            document.getElementById('check-icons').innerText = i; document.getElementById('scanned-name').innerText = n; document.getElementById('scanned-info').innerText = f;
            document.getElementById('feedback-content').className = `text-center text-white p-10 rounded-[3rem] shadow-2xl ${b} border border-white/20`;
            fb.classList.remove('hidden'); setTimeout(() => fb.classList.add('hidden'), 2000);
        }
        function setMode(mode) { currentMode = mode; document.getElementById('mode-islam').classList.toggle('active-mode-islam', mode === 'Islam'); document.getElementById('mode-kristen').classList.toggle('active-mode-kristen', mode === 'Kristen'); }

        window.onload = init;
    </script>
</body>
</html>
